<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
        integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">
    <link rel="stylesheet" href="./reset.css">
    <style>
        /* 字型一樣 */
        /* .Consolas {
            font-family: Consolas;
        }
        .Arial {
            font-family: Arial, Helvetica, sans-serif;
        } */

        .btn:focus,
        /*清除btn按鈕點擊出現的邊框*/
        .btn:active:focus,
        .btn.active:focus,
        .btn.focus,
        .btn:active.focus,
        .btn.active.focus,
        input,
        textarea,
        button:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        .container {
            max-width: 1200px;
            min-width: 750px;
        }

        .wordbox {
            position: absolute;
            left: 18%;
        }

        h1 {
            font-family: Consolas;
        }

        h1,
        #fri,
        #sat {
            color: #DB8E71;
        }

        .titlebox {
            margin: 2%;
        }

        /* .icon {
            width: 5%;
        } */

        i::before {
            /* font-size: 80%; */
            color: #FAD689;
        }

        /* i:hover{
            color: #8E354A;
        } */

        .backgroundgrey {
            background-color: #BDC0BA;
        }

        .th {
            font-family: Consolas;
            width: 100%/7;
            padding: 0% 4% 2% 4%;
            color: aliceblue;
        }

        .tr {
            margin-bottom: 5px;
        }

        .td {
            /* 字型一樣 */
            font-family: Consolas;
            width: 100%/7;
            border-radius: 50%;
            background-color: #535953;
            padding: 4%;
            color: aliceblue;
            /* margin-left: 2%; */
            /* margin-bottom: 2%; */
            position: relative;
        }

        ul {
            position: absolute;
        }

        td .btn {
            line-height: 0 !important;
            padding: 0 !important;
        }

        .modal-content {
            background-color: #bcb8b1;
        }

        #jumpdate,
        .modal-title {
            font-weight: 700;
            color: #463f3a;
        }

        #jumpdiv {
            height: 100vh;
        }

        #itembtn {
            color: #f3d8c7;
            font-weight: 500;
        }

        input,
        textarea {
            margin-bottom: 2%;
            text-align: center;
            border-radius: 5px;
            background-color: #fbfbf2;
            resize: vertical;
            border: solid 1px whitesmoke;

        }

        li {
            margin-bottom: 2%;
            color: #463f3a;
            font-weight: 700;
        }

        input {
            display: block;
            border: solid 2px #463f3a;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row position-relative">
            <div class="col-8 wordbox">
                <div class="row titlebox">
                    <div class="col-10">
                        <h1 class="title fs-2 fw-bold text-center">year-month</h1>
                    </div>
                    <div class="col-1 icon">
                        <i class="fas fa-chevron-circle-left fs-2 btn" onclick="lastMonth()"></i>
                    </div>
                    <div class="col-1 icon">
                        <i class="fas fa-chevron-circle-right fs-2 btn" onclick="nextMonth()"></i>
                    </div>
                </div>
                <div class="row tablebox">
                    <div class="col-12">
                        <div class="row theadbox">
                            <div class="col-12 tr d-flex justify-content-evenly ">
                                <div class="th fw-bold fs-3 text-center">S</div>
                                <div class="th fw-bold fs-3 text-center">M</div>
                                <div class="th fw-bold fs-3 text-center">T</div>
                                <div class="th fw-bold fs-3 text-center">W</div>
                                <div class="th fw-bold fs-3 text-center">T</div>
                                <div class="th fw-bold fs-3 text-center" id="fri">F</div>
                                <div class="th fw-bold fs-3 text-center" id="sat">S</div>
                            </div>
                        </div>
                        <div class="row tbodybox">
                            <!-- 動態生成tbody內物件 -->
                            <!-- <div class="col-12 tr d-flex justify-content-evenly weektr">
                                <div class="td fs-5 ">01</div>
                                <div class="td fs-5 ">02</div>
                                <div class="td fs-5 ">03</div>
                                <div class="td fs-5 ">04</div>
                                <div class="td fs-5 ">05</div>
                                <div class="td fs-5 ">06</div>
                                <div class="td fs-5 ">07</div>
                            </div>
                            <div class="col-12 tr d-flex
                            justify-content-evenly">
                                <div class="td fs-5 ">11</div>
                                <div class="td fs-5 ">21</div>
                                <div class="td fs-5 ">31</div>
                                <div class="td fs-5 ">41</div>
                                <div class="td fs-5 ">51</div>
                                <div class="td fs-5 ">61</div>
                                <div class="td fs-5 ">71</div>
                            </div> -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row backgroundimg">
            <div class="col-8 backgroundgrey "></div>
            <div class="col-4 ">
                <img src="./b-03.png" alt="" class="img-fluid">
            </div>
        </div>
    </div>
    <!-- 新增Modal -->
    <div id="add-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex flex-column align-items-center">
                    <input id="add-date" type="text">
                    <input id="add-title" type="text">
                    <textarea name="add" id="add-txt" cols="30" rows="10"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" data-bs-dismiss="modal"><i class="fas fa-trash-alt"></i></button>
                    <button type="button" class="btn" onclick="addTodoItem()"><i class="fas fa-check"></i></button>
                </div>
            </div>
        </div>
    </div>
    <!-- 編輯Modal -->
    <div id="edit-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">編輯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex flex-column align-items-center">
                    <input id="edit-date" type="text">
                    <input id="edit-title" type="text">
                    <textarea name="edit" id="edit-txt" cols="30" rows="10"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" data-bs-dismiss="modal" onclick="deleteTodoItem()"><i
                            class="fas fa-trash-alt"></i></button>
                    <button type="button" class="btn" onclick="editTodoItem()"><i
                            class="fas fa-pencil-alt"></i></button>
                </div>
            </div>
        </div>
    </div>
    <!-- 彈跳Modal -->
    <div id="jump-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered ">
            <div class="modal-content">
                <div class="modal-header">
                    <p id="jumpdate"></p>
                    <h5 class="modal-title">事項列表</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body jumpdiv">
                    <!-- <div class="jumpdiv"></div> -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn jumpbtn"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"
        integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
        integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
        crossorigin="anonymous"></script>
    <script>
        //宣告
        //一點開畫面要先知道今天
        const today = new Date()
        //今天的年月日
        let year = today.getFullYear()
        let month = today.getMonth()
        let date = today.getDate()

        //不知道會抓到哪一個，所以為了抓編輯事件的索引
        let currentTodoIndex

        //dom
        const tbody = document.querySelector('.tbodybox')
        const title = document.querySelector('h1')
        const arrowBtn = document.getElementById('')

        const addModal = document.getElementById('add-modal')
        const addDate = document.getElementById('add-date')
        const addTitle = document.getElementById('add-title')
        const addTxt = document.getElementById('add-txt')

        const editModal = document.getElementById('edit-modal')
        const editDate = document.getElementById('edit-date')
        const editTitle = document.getElementById('edit-title')
        const editTxt = document.getElementById('edit-txt')

        //裝代辦事項的modal 及item btn
        const jumpModal = document.getElementById('jump-modal')
        const jumpDiv = document.querySelector('.jumpdiv')
        const jumpBtn = document.querySelector('.jumpbtn')
        const jumpDate = document.getElementById('jumpdate')
        jumpDate.classList.add('me-2')
        //window.onload
        window.onload = function () {
            init()
        }
        //function
        function init() {
            tbody.innerHTML = ''
            title.innerText = `${year}-${month + 1}`
            //初始1號
            let day = 1
            //tr 禮拜數
            //td 日期數
            //每個日期要兩個數字外觀關係
            //1號是禮拜幾
            let firstDay = new Date(year, month, 1).getDay()
            //這個月有幾天=下個月的第0天
            let lastDay = new Date(year, month + 1, 0).getDate()

            //上個月最後一天
            let dayOfLastMonth = new Date(year, month, 0).getDate()
            //下個月的第一天
            let dayOfNextMonth = 1

            let weeks = Math.ceil((firstDay + lastDay) / 7)
            // console.log(weeks);
            for (let week = 0; week < weeks; week++) {
                //生成tr
                let tr = document.createElement('tr')
                tr.classList.add('col-12', 'tr', 'd-flex', 'justify-content-evenly')
                for (let col = 0; col < 7; col++) {
                    let td = document.createElement('td')
                    let itemButton = document.createElement('button')
                    itemButton.innerText = 'items'
                    itemButton.classList.add('class', 'btn')
                    itemButton.setAttribute('id', 'itembtn')
                    td.classList.add('td', 'fs-4', 'inline-block')

                    if (week == 0 && col < firstDay) {
                        //上個月
                        td.innerText = (dayOfLastMonth - firstDay + 1).toString().padStart(2, '0')
                        dayOfLastMonth++
                        td.classList.add('opacity-25')

                        // itemButton.innerText = 'items'
                        td.append(itemButton)
                    }
                    else {
                        if (day <= lastDay) {
                            //這個月
                            let testDay = day.toString().padStart(2, '0')
                            td.innerText = day.toString().padStart(2, '0')
                            //渲染畫面

                            //點下item(itemButton)時，不管裡面有沒有代辦事項都可以點擊
                            itemButton.onclick = function () {
                                //清空事項列表
                                jumpDiv.innerHTML = ''
                                bootstrap.Modal.getOrCreateInstance(jumpModal).show()

                                jumpDate.innerText = `${year}-${month + 1}-${td.childNodes[0].data}`
                                //點到jump modal的body時
                                jumpDiv.onclick = function () {
                                    addTitle.value = ''
                                    addTxt.value = ''
                                    //bootsrtap.modal.getOrCreateInstance(addModel).show()//.hide()//控制modal(bootstrap的語法)
                                    bootstrap.Modal.getOrCreateInstance(addModal).show()
                                    addDate.value = jumpDate.innerText
                                    console.log(addDate.value);
                                    bootstrap.Modal.getOrCreateInstance(jumpModal).hide()
                                }
                                //點到icon + 時
                                jumpBtn.onclick = function () {
                                    addTitle.value = ''
                                    addTxt.value = ''
                                    bootstrap.Modal.getOrCreateInstance(addModal).show()
                                    addDate.value = jumpDate.innerText
                                    bootstrap.Modal.getOrCreateInstance(jumpModal).hide()
                                }
                                //如果現在是空的我就新增一個代辦事項給他
                                if (localStorage.getItem(`${year}-${month + 1}-${td.childNodes[0].data}`) != null) {

                                    let ul = document.createElement('ul')
                                    //從localStorage找日期
                                    //td.childNodes[0].data ->日期
                                    let todoList = JSON.parse(localStorage.getItem(`${year}-${month + 1}-${td.childNodes[0].data}`))
                                    //所有代辦事項迭代
                                    todoList.forEach((item, index) => {
                                        let li = document.createElement('li')
                                        li.innerText = `${index + 1}: ${item.title}`
                                        //點到li時，可以編輯
                                        li.onclick = function (event) {
                                            bootstrap.Modal.getOrCreateInstance(jumpModal).hide()
                                            bootstrap.Modal.getOrCreateInstance(editModal).show()

                                            currentTodoIndex = index
                                            editDate.value = `${year}-${month + 1}-${td.childNodes[0].data}`
                                            // console.log(td.childNodes);
                                            editTitle.value = item.title
                                            editTxt.value=item.txt
                                            //避免冒泡
                                            event.stopPropagation()
                                        }
                                        ul.append(li)
                                    })
                                    jumpDiv.append(ul)
                                }
                                //如果沒有代辦事項時，也可以增加事項，要可以按jumpDiv和 jumpBtn
                                else {
                                    jumpDiv.onclick = function () {
                                        bootstrap.Modal.getOrCreateInstance(addModal).show()
                                        addDate.value = jumpDate.innerText
                                        bootstrap.Modal.getOrCreateInstance(jumpModal).hide()
                                    }
                                    jumpBtn.onclick = function () {
                                        bootstrap.Modal.getOrCreateInstance(addModal).show()
                                        addDate.value = jumpDate.innerText
                                        bootstrap.Modal.getOrCreateInstance(jumpModal).hide()
                                    }
                                }
                            }

                        } else {
                            //下個月
                            td.innerText = dayOfNextMonth.toString().padStart(2, '0')
                            dayOfNextMonth++
                            td.classList.add('opacity-25')
                        }
                        day++
                        td.append(itemButton)
                    }
                    tr.appendChild(td)
                }
                tbody.appendChild(tr)
            }
        }
        //上個月
        function lastMonth() {
            month--
            if (month == -1) {
                month = 11
                year--
            }
            init()

        }
        //下個月
        function nextMonth() {
            month++
            if (month == 12) {
                month = 0
                year++
            }
            init()
        }
        //新增行程
        function addTodoItem() {
            let date = addDate.value
            let todoItem = addTitle.value
            let todoTex = addTxt.value

            //自己創造的資料結構
            let todoObj = {
                title: todoItem,
                txt: todoTex
            }
            let todoList = []
            if (localStorage.getItem(date) == null) {
                //那天沒行程->直接加行程
                todoList.push(todoObj)
            }
            else {
                //那天有行程
                //從localstorage.getItem(date)得到資料轉成JSON
                todoList = JSON.parse(localStorage.getItem(date))
                todoList.push(todoObj)
            }
            //存回localstorage
            localStorage.setItem(date, JSON.stringify(todoList))

            bootstrap.Modal.getOrCreateInstance(addModal).hide()
            init()
        }
        //修改行程
        function editTodoItem() {
            let date = editDate.value
            let todoItem = editTitle.value
            let todoTxt = editTxt.value
            let todoList = JSON.parse(localStorage.getItem(date))
            todoList[currentTodoIndex] = {
                title: todoItem,
                txt: todoTxt
            }
            localStorage.setItem(date, JSON.stringify(todoList))

            bootstrap.Modal.getOrCreateInstance(editModal).hide()
            init()
        }
        //刪除行程
        function deleteTodoItem() {
            let date = editDate.value
            let todoList = JSON.parse(localStorage.getItem(date))
            todoList.splice(currentTodoIndex, 1)
            localStorage.setItem(date, JSON.stringify(todoList))

            bootstrap.Modal.getOrCreateInstance(addModal).hide()
            init()
        }

    </script>

</body>

</html>